<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Containers From Scratch Part 1" /><meta property="og:locale" content="en" /><meta name="description" content="At the end of the day, all a container is an isolated service with its dependencies, this document will go over how to create a container from scratch, using nothing but the built-in Linux kernel modules." /><meta property="og:description" content="At the end of the day, all a container is an isolated service with its dependencies, this document will go over how to create a container from scratch, using nothing but the built-in Linux kernel modules." /><link rel="canonical" href="https://tamalerhino.github.io/posts/container-from-scratch/" /><meta property="og:url" content="https://tamalerhino.github.io/posts/container-from-scratch/" /><meta property="og:site_name" content="Tamalerhino’s Blog" /><meta property="og:image" content="https://tamalerhino.github.io/pexels-pixabay-73833.jpg" /><meta property="og:image:height" content="800" /><meta property="og:image:width" content="1000" /><meta property="og:image:alt" content="Containers" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-02-11T11:00:00-06:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://tamalerhino.github.io/pexels-pixabay-73833.jpg" /><meta name="twitter:image:alt" content="Containers" /><meta property="twitter:title" content="Containers From Scratch Part 1" /><meta name="twitter:site" content="@tamalerhino" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-25T20:21:39-05:00","datePublished":"2022-02-11T11:00:00-06:00","description":"At the end of the day, all a container is an isolated service with its dependencies, this document will go over how to create a container from scratch, using nothing but the built-in Linux kernel modules.","headline":"Containers From Scratch Part 1","image":{"width":1000,"height":800,"alt":"Containers","url":"https://tamalerhino.github.io/pexels-pixabay-73833.jpg","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://tamalerhino.github.io/posts/container-from-scratch/"},"url":"https://tamalerhino.github.io/posts/container-from-scratch/"}</script><title>Containers From Scratch Part 1 | Tamalerhino's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Tamalerhino's Blog"><meta name="application-name" content="Tamalerhino's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/tamalerhino2-1mb.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Tamalerhino's Blog</a></div><div class="site-subtitle font-italic">Just one rhino's thoughts.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/tamalerhino" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/tamalerhino" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/in/ulises-galeano/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Containers From Scratch Part 1</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Containers From Scratch Part 1</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1644598800" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 11, 2022 </em> </span> <span> Updated <em class="" data-ts="1664155299" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 25, 2022 </em> </span><div class="mt-3 mb-3"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 800'%3E%3C/svg%3E" data-src="/assets/img/posts/pexels-pixabay-73833.jpg" class="preview-img bg" alt="Containers" width="1000" height="800" data-proofer-ignore><figcaption class="pt-2 pb-2">Containers</figcaption></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/tamalerhino">Ulises Galeano</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1572 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><p>At the end of the day, all a container is an isolated service with its dependencies, this document will go over how to create a container from scratch, using nothing but the built-in Linux kernel modules.</p><h2 id="how"><span class="mr-2">How?</span><a href="#how" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As mentioned before, a container is nothing more than an isolated service running on the linux Kernel. How it does this is by using kernel level modules known as <code class="language-plaintext highlighter-rouge">namespaces</code>,<code class="language-plaintext highlighter-rouge">cgroups</code> and something called <code class="language-plaintext highlighter-rouge">capabilities</code>.</p><p>For a deeper explanation of containers,namespaces,cgroups etc see my blog on Namespaces</p><h2 id="prereqs"><span class="mr-2">Prereqs</span><a href="#prereqs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>You will need some linux folders and structures, there are two ways to go about this.</p><ul><li>Using a Docker image, or rather exporting a Docker image.<li>Downloading a basic filesystem or creating it from scratch.(checkout my other blog on creating debian distro from scratch “Bootstrapping Debian As a Container Image”)</ul><h3 id="option-1-creating-the-container-image"><span class="mr-2">Option 1 Creating The Container Image</span><a href="#option-1-creating-the-container-image" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>On the machine a you have Docker installed.</p><ol><li><p>Pull the alpine image <code class="language-plaintext highlighter-rouge">docker pull alpine</code></p><li><p>Run the container <code class="language-plaintext highlighter-rouge">docker run -d --name alpine alpine</code></p><li><p>Finally export the image to a tar file. <code class="language-plaintext highlighter-rouge">docker export --output=alpine.tar alpine</code></p></ol><p>You will have a tar file that you can put anywhere to save for later.</p><h3 id="option-2-from-scratch"><span class="mr-2">Option 2 From Scratch</span><a href="#option-2-from-scratch" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Follow my other blog “Bootstrapping Debian As a Container Image” to get a tar.gz of a basic debian filesystem.</p><h1 id="creating-container">Creating Container</h1><h2 id="with-chroot"><span class="mr-2">With CHROOT</span><a href="#with-chroot" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote class="prompt-warning"><div><p>If you went the docker route just replace <code class="language-plaintext highlighter-rouge">debian</code> to <code class="language-plaintext highlighter-rouge">alpine</code> or whatever you named your tar file.</p></div></blockquote><p>Get your tar image using <code class="language-plaintext highlighter-rouge">wget</code> or <code class="language-plaintext highlighter-rouge">curl</code></p><p>Untar the image and take a look around, its just like any other linux distro.</p><blockquote class="prompt-tip"><div><p>Be adviced if you mess up the commands you will need to <code class="language-plaintext highlighter-rouge">su</code> to <code class="language-plaintext highlighter-rouge">root</code> because of permissions to delete stuff.</p></div></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>tamalerhino@localhost:~<span class="nv">$ </span><span class="nb">sudo mkdir </span>debian
tamalerhino@localhost:~<span class="nv">$ </span><span class="nb">sudo tar</span> <span class="nt">-xzf</span> debian.tar.gz <span class="nt">-C</span> debian
tamalerhino@localhost:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> debian/
tamalerhino@localhost:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-al</span> debian/etc/
</pre></table></code></div></div><p>We will use <code class="language-plaintext highlighter-rouge">chroot</code> (old school!) to restrict the view of the process.</p><blockquote class="prompt-info"><div><p>This is what docker does when it does <code class="language-plaintext highlighter-rouge">docker run</code></p></div></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>tamalerhino@localhost:~<span class="nv">$ </span><span class="nb">sudo chroot </span>debian /bin/bash
root@localhost:/#  <span class="nb">ls
</span>bin  boot  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
root@localhost:/#  <span class="nb">echo</span> <span class="s2">"Meow"</span>
Meow
root@localhost:/# <span class="nb">exit</span>
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>Instead of a shell, we can run a command inside our <code class="language-plaintext highlighter-rouge">chroot</code>.</p></div></blockquote><blockquote class="prompt-info"><div><p>Similar to dockers <code class="language-plaintext highlighter-rouge">docker exec -d &lt;container&gt; echo "Hello World"</code></p></div></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>tamalerhino@localhost:~<span class="nv">$ </span><span class="nb">sudo chroot </span>debian <span class="nb">echo</span> <span class="s2">"meow"</span>
meow
tamalerhino@localhost:~<span class="nv">$ </span>
</pre></table></code></div></div><blockquote class="prompt-warning"><div><p>Now of course if you try to install something using <code class="language-plaintext highlighter-rouge">apt</code> you will get an error since it does not have connectivity to the outside. Everything were running is from within our container.</p></div></blockquote><blockquote class="prompt-danger"><div><p>However it’s not completely isolated yet!</p></div></blockquote><p>You can check this by running <code class="language-plaintext highlighter-rouge">top</code> from outside the chroot container.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>tamalerhino@localhost:~<span class="nv">$ </span>top &amp;
<span class="o">[</span>2] 1619
</pre></table></code></div></div><p>Then run the following commands to see that you can see the top command inside the chroot container.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>tamalerhino@localhost:~<span class="nv">$ </span><span class="nb">sudo chroot </span>debian /bin/bash
root@localhost:/# mount <span class="nt">-t</span> proc proc /proc
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>The <code class="language-plaintext highlighter-rouge">mount -t proc..</code> commands are needed because when you run <code class="language-plaintext highlighter-rouge">ps</code> it is checking the <code class="language-plaintext highlighter-rouge">/proc</code> filesystem for the file representation of the running processes, and so we need to mount the <code class="language-plaintext highlighter-rouge">/proc</code> global FS.</p></div></blockquote><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>root@localhost:/# ps aux | <span class="nb">grep </span>top
1000      7725  0.0  0.0  10396  3240 ?        T    22:18   0:00 top
root      7761  0.0  0.0   8172   668 ?        S+   22:19   0:00 <span class="nb">grep </span>top
root@localhost:/#
</pre></table></code></div></div><p>You should not be able to see that root process inside the container. Whats worse is you can actually kill that service from inside the container by running</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>root@localhost:/# pkill top
</pre></table></code></div></div><p>That defeats the purpouse of containers right?!</p><h2 id="isolation-namespaces"><span class="mr-2">Isolation (namespaces)</span><a href="#isolation-namespaces" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>OK now to isolate the whole thing using a <a href="https://en.wikipedia.org/wiki/System_call">syscall</a> called <a href="https://linux.die.net/man/2/unshare">unshare</a> by using the CLI tool by the same name. This will create a namespace for our container to run in.</p><p>Below what we are doing is going into the debian directory, just like we would with <code class="language-plaintext highlighter-rouge">chroot</code> but now were giving ourselves specific namespaces to isolate the environment from the host environment and running <code class="language-plaintext highlighter-rouge">bash</code> as our process(the <code class="language-plaintext highlighter-rouge">--fork</code> flag is just saying we want to run bash as a child service of the unshare command.)</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>tamalerhino@localhost:~<span class="nv">$ </span><span class="nb">cd </span>debian
tamalerhino@localhost:~/debian<span class="nv">$ </span><span class="nb">sudo </span>unshare <span class="nt">--mount</span> <span class="nt">--uts</span> <span class="nt">--fork</span> bash
root@localhost:/home/tamalerhino/debian#
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>When we run the <code class="language-plaintext highlighter-rouge">unshare</code> command and the namespaces eg <code class="language-plaintext highlighter-rouge">--mount</code>,<code class="language-plaintext highlighter-rouge">--uts</code> what were saying is: create an envionrment and give us our own instances of these namespaces for example <code class="language-plaintext highlighter-rouge">--mount</code> were saying we want our own mounts ie the ability to mount things only to our environement and not the host environment.</p></div></blockquote><p>To test that youre in a container lets try changing the hostname</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>root@localhost:/home/tamalerhino/debian# <span class="nb">hostname </span>container
root@localhost:/home/tamalerhino/debian# <span class="nb">exec </span>bash
root@container:/home/tamalerhino/debian#
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>We have the ability to change the internal hostname of the container without changing the host’s hostname because we gave ourselves the <code class="language-plaintext highlighter-rouge">--uts</code> namespace earlier.</p></div></blockquote><p>Open up a second terminal so you can check to see that your host system hostname has not changed!</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c"># Second Terminal</span>
tamalerhino@localhost:~<span class="nv">$ </span><span class="nb">hostname
</span>localhost
</pre></table></code></div></div><p>Now to fix the issue with the fact that we can kill processes, if you were to run <code class="language-plaintext highlighter-rouge">ps</code> from inside the container right now this is what you would see:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>root@container:/home/tamalerhino/debian# ps
  PID TTY          TIME CMD
10976 pts/3    00:00:00 <span class="nb">sudo
</span>10977 pts/3    00:00:00 unshare
10978 pts/3    00:00:00 bash
10989 pts/3    00:00:00 ps
root@container:/home/tamalerhino/debian#
</pre></table></code></div></div><p>We dont want that! The reason we are seeing that is because when we mounted everything we also added the global <code class="language-plaintext highlighter-rouge">/proc</code> directory to the container. Lets only mount our debian <code class="language-plaintext highlighter-rouge">/proc</code> directory to our namespace as well as the <code class="language-plaintext highlighter-rouge">--pid</code>, and <code class="language-plaintext highlighter-rouge">--ipc</code> namespaces.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>root@container:/home/tamalerhino/debian# mount <span class="nt">-t</span> proc proc /proc
root@container:/home/tamalerhino/debian# ps
  PID TTY          TIME CMD
    1 pts/3    00:00:00 bash
   11 pts/3    00:00:00 ps
root@container:/home/tamalerhino/debian#
</pre></table></code></div></div><p>Now we can only see our processes.</p><blockquote class="prompt-tip"><div><p>Another way to do this is to add the <code class="language-plaintext highlighter-rouge">/proc</code> mountpoint to our original <code class="language-plaintext highlighter-rouge">unshare</code> command ` sudo unshare –mount –uts –ipc –pid –mount-proc=/proc –fork bash`</p></div></blockquote><p>Lets go ahead and take it one step further by telling the system that our root <code class="language-plaintext highlighter-rouge">/</code> directory is at the debian directory, we can do this by using <code class="language-plaintext highlighter-rouge">pivot_root</code>.</p><blockquote class="prompt-info"><div><p>From the man page: “pivot_root() changes the root mount in the mount namespace of the calling process. More precisely, it moves the root mount to the directory put_old and makes new_root the new root mount.”</p></div></blockquote><p>First we need to create a directory where our current root filesystem will be mounted.</p><blockquote class="prompt-tip"><div><p>Before you being create a file in your debian directory so you know that you are actually in your deban root directory later on like so <code class="language-plaintext highlighter-rouge">touch /home/tamalerhino/debian/DEEEEEEB</code></p></div></blockquote><p>First we need to make a new directory close to our <code class="language-plaintext highlighter-rouge">/</code> root FS now.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>root@container:/home/tamalerhino/debian# <span class="nb">mkdir</span> /newroot
</pre></table></code></div></div><p>Then we will bind mount our debian root fs to this newroot directory.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>root@container:/home/tamalerhino/debian# mount <span class="nt">--bind</span> /home/tamalerhino/debian /newroot
</pre></table></code></div></div><p>Now we can go to the root FS and show that the <code class="language-plaintext highlighter-rouge">newroot</code> directory is there and our debian fs is mounted there.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>root@container:/home/tamalerhino/debian# <span class="nb">cd</span> /
root@container:/# <span class="nb">ls
</span>bin   dev  home  lib32  libx32      media  newroot  proc  run   snap  swap.img  tmp  var
boot  etc  lib   lib64  lost+found  mnt    opt      root  sbin  srv   sys       usr
root@container:/# <span class="nb">cd </span>newroot/
root@container:/newroot# <span class="nb">ls
</span>DEEEEEEB  boot  etc   lib    lib64   media  opt   root  sbin  sys  usr
bin       dev   home  lib32  libx32  mnt    proc  run   srv   tmp  var
</pre></table></code></div></div><p>Now comes the cool part we will use the command <code class="language-plaintext highlighter-rouge">pivot_root</code> to tell the system that our root FS is no longer the <code class="language-plaintext highlighter-rouge">/</code> but really now its <code class="language-plaintext highlighter-rouge">/newroot</code> and to treat it as such.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>root@container:/newroot# pivot_root <span class="nb">.</span> <span class="nb">.</span>
root@container:/newroot# <span class="nb">cd</span> /
root@container:/# <span class="nb">ls
</span>DEEEEEEB  boot  etc   lib    lib64   media  opt   root  sbin  sys  usr
bin       dev   home  lib32  libx32  mnt    proc  run   srv   tmp  var
</pre></table></code></div></div><p>See! now everytime we use <code class="language-plaintext highlighter-rouge">/</code> it points to our debian FS.</p><h3 id="now-to-do-a-little-cleanup"><span class="mr-2">Now to do a little cleanup</span><a href="#now-to-do-a-little-cleanup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This is a good stoping point, at this point we have a container that only sees its own processes, its own mounts and its own rootfs but we still need immutable volumes, networking and a little security. All this and much more to come in Part 2!</p><p>First run the following command since mount relies on this.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>root@container:/# mount <span class="nt">-t</span> proc proc /proc
</pre></table></code></div></div><p>Now to see whats mounted. Only reason im running head is to get the first 10 lines otherwise it would be too much to render for the blog.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>root@container:/# mount | <span class="nb">head</span>
/dev/mapper/ubuntu--vg-ubuntu--lv on / <span class="nb">type </span>ext4 <span class="o">(</span>rw,relatime<span class="o">)</span>
udev on /dev <span class="nb">type </span>devtmpfs <span class="o">(</span>rw,nosuid,relatime,size<span class="o">=</span>1936540k,nr_inodes<span class="o">=</span>484135,mode<span class="o">=</span>755,inode64<span class="o">)</span>
devpts on /dev/pts <span class="nb">type </span>devpts <span class="o">(</span>rw,nosuid,noexec,relatime,gid<span class="o">=</span>5,mode<span class="o">=</span>620,ptmxmode<span class="o">=</span>000<span class="o">)</span>
tmpfs on /dev/shm <span class="nb">type </span>tmpfs <span class="o">(</span>rw,nosuid,nodev,inode64<span class="o">)</span>
mqueue on /dev/mqueue <span class="nb">type </span>mqueue <span class="o">(</span>rw,nosuid,nodev,noexec,relatime<span class="o">)</span>
hugetlbfs on /dev/hugepages <span class="nb">type </span>hugetlbfs <span class="o">(</span>rw,relatime,pagesize<span class="o">=</span>2M<span class="o">)</span>
tmpfs on /run <span class="nb">type </span>tmpfs <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,size<span class="o">=</span>398444k,mode<span class="o">=</span>755,inode64<span class="o">)</span>
tmpfs on /run/lock <span class="nb">type </span>tmpfs <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,size<span class="o">=</span>5120k,inode64<span class="o">)</span>
none on /run/credentials/systemd-sysusers.service <span class="nb">type </span>ramfs <span class="o">(</span>ro,nosuid,nodev,noexec,relatime,mode<span class="o">=</span>700<span class="o">)</span>
tmpfs on /run/snapd/ns <span class="nb">type </span>tmpfs <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,size<span class="o">=</span>398444k,mode<span class="o">=</span>755,inode64<span class="o">)</span>
</pre></table></code></div></div><p>Go ahead and unmount everything</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>root@container:/# umount <span class="nt">-a</span>
umount: /: target is busy.
...
</pre></table></code></div></div><blockquote class="prompt-tip"><div><p>If you get errors like the one above saying something is busy just run <code class="language-plaintext highlighter-rouge">umount -l &lt;the mount thats busy&gt;</code> in my case <code class="language-plaintext highlighter-rouge">umount -l /</code></p></div></blockquote><p>Now when we run mount we see we get a nice little isolated container mounts.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>root@container:/# mount
/dev/mapper/ubuntu--vg-ubuntu--lv on / <span class="nb">type </span>ext4 <span class="o">(</span>rw,relatime<span class="o">)</span>
proc on /proc <span class="nb">type </span>proc <span class="o">(</span>rw,relatime<span class="o">)</span>
proc on /proc <span class="nb">type </span>proc <span class="o">(</span>rw,relatime<span class="o">)</span>
</pre></table></code></div></div><h1 id="resources">Resources</h1><ul><li>https://ericchiang.github.io/post/containers-from-scratch/<li>https://lwn.net/Articles/531114/<li>https://blog.nicolasmesa.co/posts/2018/08/container-creation-using-namespaces-and-bash/<li>https://www.redhat.com/sysadmin/net-namespaces<li>https://en.wikipedia.org/wiki/Linux_namespaces<li>https://wiki.archlinux.org/title/Linux_Containers</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/containerization/'>Containerization</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/containerization/" class="post-tag no-text-decoration" >containerization</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >docker</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Containers+From+Scratch+Part+1+-+Tamalerhino%27s+Blog&url=https%3A%2F%2Ftamalerhino.github.io%2Fposts%2Fcontainer-from-scratch%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Containers+From+Scratch+Part+1+-+Tamalerhino%27s+Blog&u=https%3A%2F%2Ftamalerhino.github.io%2Fposts%2Fcontainer-from-scratch%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ftamalerhino.github.io%2Fposts%2Fcontainer-from-scratch%2F&text=Containers+From+Scratch+Part+1+-+Tamalerhino%27s+Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/container-from-scratch/">Containers From Scratch Part 1</a><li><a href="/posts/systemd-namespace-containers/">Systemd Namespace Containers</a><li><a href="/posts/docker-debian-airgapped/">Install Docker Air Gapped</a><li><a href="/posts/docker-desktop-wsl2-deep-dive/">Docker Desktop WSL2 Deep Dive</a><li><a href="/posts/how-to-abuse-container-repositories-for-fun-and-profit/">How To Abuse Container Repositories For Fun And Profit</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/containerization/">containerization</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/docker-desktop/">docker desktop</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wsl2/">wsl2</a> <a class="post-tag" href="/tags/wsl/">wsl</a> <a class="post-tag" href="/tags/data-exfiltration/">data exfiltration</a> <a class="post-tag" href="/tags/devsecops/">devsecops</a> <a class="post-tag" href="/tags/dlp/">dlp</a> <a class="post-tag" href="/tags/hacking/">hacking</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/docker-desktop-wsl2-deep-dive/"><div class="card-body"> <em class="small" data-ts="1633107600" data-df="ll" > Oct 1, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Docker Desktop WSL2 Deep Dive</h3><div class="text-muted small"><p> In the last few years theres been a big push for Docker Desktop on developer workstations, many of those workstations being Mac and Windows not Linux. But since containers need a Linux kernel to ru...</p></div></div></a></div><div class="card"> <a href="/posts/how-to-abuse-container-repositories-for-fun-and-profit/"><div class="card-body"> <em class="small" data-ts="1635008400" data-df="ll" > Oct 23, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How To Abuse Container Repositories For Fun And Profit</h3><div class="text-muted small"><p> Often as security engineers we are worried about what vulnerabilites can be downloaded from container registries, howver i believe the same could be used to exfiltrate data. We will go over what a...</p></div></div></a></div><div class="card"> <a href="/posts/creating-a-custom-wsl2-image/"><div class="card-body"> <em class="small" data-ts="1636650000" data-df="ll" > Nov 11, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Creating A Custom WSL2 Image</h3><div class="text-muted small"><p> Recently with the usage of Docker Desktop, there has been a need to use WSL2 to run Docker Desktop on Windows. However because of the various security implications, missing security kernel modules,...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/bootstrapping-debian-as-a-container-image-pt1/" class="btn btn-outline-primary" prompt="Older"><p>Bootstrapping Debian as a Container Image</p></a> <a href="/posts/container-from-scratch-pt2/" class="btn btn-outline-primary" prompt="Newer"><p>Containers From Scratch Part 2</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/tamalerhino">Ulises Galeano</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/containerization/">containerization</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/docker-desktop/">docker desktop</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/wsl2/">wsl2</a> <a class="post-tag" href="/tags/wsl/">wsl</a> <a class="post-tag" href="/tags/data-exfiltration/">data exfiltration</a> <a class="post-tag" href="/tags/devsecops/">devsecops</a> <a class="post-tag" href="/tags/dlp/">dlp</a> <a class="post-tag" href="/tags/hacking/">hacking</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
